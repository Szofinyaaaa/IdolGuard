import discord
from discord.ext import commands
import asyncio
import os

intents = discord.Intents.default()
intents.members = True
intents.messages = True
intents.message_content = True

bot = commands.Bot(command_prefix="!", intents=intents)

VERIFIED_ROLE = "Cosmic Sparks"
pending_verifications = {}

if not os.path.exists("verifications"):
    os.makedirs("verifications")

# Lista a m√°r √©rtes√≠tett tagokhoz (offline bel√©p≈ëk catch-up)
unverified_members = set()

@bot.event
async def on_ready():
    print(f"Bot online! Logged in as {bot.user}")

    # Ellen≈ërizz√ºk a szerver tagjait
    for guild in bot.guilds:
        role = discord.utils.get(guild.roles, name=VERIFIED_ROLE)
        for member in guild.members:
            if role not in member.roles and not member.bot:
                unverified_members.add(member.id)
                try:
                    await member.send(
                        "√ögy t≈±nik, lemaradt√°l a Cosmic Sparks verifik√°ci√≥r√≥l, mivel a bot offline volt üò∫\n"
                        "K√©rlek t√∂lts fel egy selfie-t a hiteles√≠t√©shez!"
                    )
                except discord.Forbidden:
                    print(f"Nem tudtam DM-et k√ºldeni {member.name}-nek.")

@bot.event
async def on_member_join(member):
    try:
        await member.send(
            f"√údv a Nebula Paws szerveren, {member.name}! üò∫\n"
            "Miel≈ëtt teljes hozz√°f√©r√©st kapn√°l, k√©rlek t√∂lts fel egy selfie-t a hiteles√≠t√©shez. "
            "Mutasd az arcod teljesen, j√≥l l√°tsz√≥djon a szem √©s a sz√°d. üì∏"
        )
    except discord.Forbidden:
        print(f"Nem tudtam DM-et k√ºldeni {member.name}-nek.")

@bot.event
async def on_message(message):
    if message.author == bot.user:
        return

    # !verifyme parancs DM-ben
    if isinstance(message.channel, discord.DMChannel):
        if message.content.lower().startswith("!verifyme"):
            try:
                await message.author.send(
                    "K√©rlek t√∂lts fel egy selfie-t a verifik√°ci√≥hoz! üì∏"
                )
            except discord.Forbidden:
                print(f"Nem tudtam DM-et k√ºldeni {message.author.name}-nek.")
            return

        if message.attachments:
            attachment = message.attachments[0]
            if attachment.filename.lower().endswith(("png", "jpg", "jpeg")):
                path = f"verifications/{message.author.id}_{attachment.filename}"
                await attachment.save(path)
                pending_verifications[message.author.id] = path
                await message.channel.send(
                    "K√©p meg√©rkezett! ‚è≥\nA bot automatikusan ellen≈ërzi, vagy ha kell, moder√°tor fogja ellen≈ërizni."
                )

                await asyncio.sleep(2)
                success = True

                for guild in bot.guilds:
                    member = guild.get_member(message.author.id)
                    if member:
                        role = discord.utils.get(guild.roles, name=VERIFIED_ROLE)
                        if not role:
                            role = await guild.create_role(name=VERIFIED_ROLE)
                        if success:
                            await member.add_roles(role)
                            await message.channel.send(
                                "‚úÖ Hiteles√≠t√©s sikeres! A Cosmic Sparks szerepk√∂r hozz√°adva."
                            )
                        else:
                            await message.channel.send(
                                "‚ùå Nem siker√ºlt az automatikus ellen≈ërz√©s. Moder√°tor fog seg√≠teni."
                            )
            else:
                await message.channel.send("K√©rlek, t√∂lts fel egy k√©pet a selfie-verifik√°ci√≥hoz.")
        else:
            await message.channel.send("K√©rlek, t√∂lts fel egy k√©pet a selfie-verifik√°ci√≥hoz.")


# Bot ind√≠t√°sa (itt kell a saj√°t tokened)
bot.run("YOUR BOT TOKEN HERE")
